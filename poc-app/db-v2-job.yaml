apiVersion: batch/v1
kind: Job
metadata:
  name: schema-migrate-v2
  annotations:
    argocd.argoproj.io/hook: PreSync
spec:
  template:
    spec:
      containers:
      - name: db-init
        image: postgres:15
        command:
        - /bin/sh
        - -c
        - |
          # 1. WAIT: Don't try to connect until the DB is actually listening
          echo "Waiting for pg-db to be ready..."
          until pg_isready -h pg-db -p 5432 -U postgres; do
            sleep 2
          done

          # 2. ACT: Now that it's ready, run the migration
          echo "Database is up! Creating table..."
          psql -h pg-db -U postgres -d postgres -c "CREATE TABLE orders (id INT);"
        env:
        # 3. AUTH: You MUST provide the password
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: pg-secret
              key: password
      restartPolicy: Never